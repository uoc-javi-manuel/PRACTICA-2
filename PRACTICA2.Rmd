---
title: "PRÁCTICA 2 - TIPOLOGÍA Y CICLO DE VIDA DE LOS DATOS"
author: "Manuel Cubertorer Gumbau y Francisco Javier Corrales Estrella"
date: "11/12/2021"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Descripción del dataset. ¿Por qué es importante y qué pregunta/problema pretende responder?

Los conjuntos de datos corresponden a una serie de registros de tipos de vino, obtenidos a partir de:

https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/

El dataset está formado por un total de 1599 registros de vino rojo y 4898 registros de vino blanco, y por 12 variables fisicoquímicas. Se definen una serie atributos como la acidez o la graduación, y una variable target con la calidad del vino.
Extraeremos los dos dataset disponibles, uno para vinos blancos y otros para vinos tintos, y los fusionaremos en uno solo creando una variable categórica para el tipo de vino, el resto de variables son numéricas.

Los campos de los que se compone el dataset son los siguientes:

- **fixed acidity**: La mayoría de los ácidos involucrados con el vino son fijos o no volátiles (no se evaporan fácilmente)
- **volatile acidity**: Cantidad de ácido acético en el vino, que en niveles demasiado altos puede llevar a un sabor desagradable a vinagre.
- **citric acid**: En pequeñas cantidades, el ácido cítrico puede agregar “frescura” y sabor a los
vinos.
- **residual sugar**: Cantidad de azúcar residual después de la fermentación. Es raro encontrar vinos con menos de 1 g/l y los vinos con más de 45 g/l se consideran dulces. 
- **chlorides**: Cantidad de sal en el vino.
- **free sulfur dioxide**: En estado natural, el SO2 presenta un equilibrio entre el SO2 molecular (como un gas disuelto) y el ion bisulfito. Previene el crecimiento microbiano y la oxidación del vino.
- **total sulfur dioxide**: Cantidad de formas libres y ligadas de SO2. En bajas concentraciones, el SO2 es mayormente indetectable en el vino, pero a concentraciones de SO2 libres superiores a 50 ppm, el SO2 se hace evidente en el olfato y también en el sabor del vino.
- **density**: Densidad del agua según el porcentaje de alcohol y contenido en azúcar.
- **pH**: Describe el grado de acidez o basicidad del vino en una escala de 0 (muy ácido) a 14 (muy básico). La mayoría de los vinos están entre 3 y 4 en la escala de pH.
- **sulphates**: Aditivo para vinos que puede contribuir a los niveles de gas de SO2, que actúa como antimicrobiano y antioxidante.
- **alcohol**: Porcentaje de alcohol en el vino.
- **quality**: Indica la calidad del vino en una escala del 1 al 10.
- **tipo_vino**: Variable categórica que distingue entre vinos blancos y vinos tintos.

Nuestro análisis, tratará de determinar que variable/s son más determinantes en la calidad del vino, y compararemos cómo influye en algunas de ellas el tipo de vino (blanco o tinto).

Este tipo de análisis son muy relevantes en el mundo de las bodegas y los vinos donde se utilizan estos datos para realizar investigaciones sobre la calidad de los vinos, las uvas y sus cualidades fisicoquímicas.


# 2. Integración y selección de los datos de interés a analizar

Primero cargamos los datos desde el repositorio de datatsets UCI Machine Learning. Luego creamos la variable "tipo" que nos indique el tipo de vino (blanco o tinto) y juntamos los dos datasets en uno.

Una **consideración importante**, es que no fusionaremos realmente los dos datasets hasta que hayamos completado las tareas de limpieza y preparación de datos pues no queremos que las distribuciones de los datos se mezclen, por ejemplo, los valores extremos los queremos tratar separados por cada tipo de vino.

```{r message=FALSE, warning=FALSE}
red_wine_data <- read.csv("http://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv", header=T, sep=";")
white_wine_data <- read.csv("http://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-white.csv", header=T, sep=";")

colnames(red_wine_data) <- c("fixed_acidity","volatile_acidity", "citric_acid", "residual_sugar", "chlorides", "free_sulfur_dioxide","total_sulfur_dioxide","density","ph","sulphates","alcohol","quality")

colnames(white_wine_data) <- c("fixed_acidity","volatile_acidity", "citric_acid", "residual_sugar", "chlorides", "free_sulfur_dioxide","total_sulfur_dioxide","density","ph","sulphates","alcohol","quality")

red_wine_data$tipo <- 'tinto'
white_wine_data$tipo <- 'blanco'

wine_data = rbind(white_wine_data, red_wine_data)
```

Ahora vamos a mostrar las primeras líneas del dataset para comprobar que se ha cargado correctamente.

```{r message= FALSE, warning=FALSE}
head(wine_data, 10)
```

A continuación mostraremos la estructura de los datos. Donde comprobamos que todas las variables son numéricas, excepto la variable categórica **tipo** que hemos creado.

```{r message= FALSE, warning=FALSE}
str(wine_data)
```

También vemos que la variable **quality** es del tipo integer, así que la transformaremos a tipo numeric para que sea completamente compatible con el resto de variables y evitar posibles conflictos.

```{r message= FALSE, warning=FALSE}
# Convertimos la columna "quality" a tipo numeric
wine_data$quality<-as.numeric(wine_data$quality)
class(wine_data$quality)
```

Por otra parte, también vemos que existen dos variables para definir la acidez (fixed_acidity y volatile_acidity). Así pues podemos crear una variable nueva llamada **acidity** que recoja la suma de estas dos y por tanto indique la acidez total del vino.

```{r message= FALSE, warning=FALSE}
# Creamos la nueva columna acidity
wine_data$acidity<-wine_data$fixed_acidity + wine_data$volatile_acidity
# Eliminamos las columnas fixed_acidity y volatile_acidity
wine_data <- wine_data[, -(1:2)]
wine_data <- subset(wine_data, select=c(12,1:11))
head(wine_data)
```

Estadísticas principales de los datos:

```{r message= FALSE, warning=FALSE}
summary(wine_data)
```

# 3. Limpieza de los datos

## 3.1 ¿Los datos contienen ceros o elementos vacíos? ¿Cómo gestionarías cada uno de estos casos?

Mostramos las estadísticas de valores vacíos o nulos.

```{r message= FALSE, warning=FALSE}
# Estadísticas de valores vacíos
colSums(is.na(wine_data))
colSums(wine_data=="")
```

En nuestro caso no existen valores nulos, si los hubiese la alternativa mas sencilla es setear el valor de la media para todo el conjunto de datos. Esto lo podemos mejorar tomando alguna medida de tendencia central dependiendo de la distribución de los datos, esto se puede hacer para toda la muestra o en función de alguna variable categórica, en nuestro caso el tipo de vino.

Existen otros métodos, como  kNN que se basa en la similitud, básicamente se fija en que valores tiene esa variable en los "vecinos" mas cercanos, donde definimos cuantos vecinos queremos tomar.´


Otro análisis que vamos a realizar para la limpieza de los datos es detectar si existen valores duplicados. Los valores duplicados no aportan ninguna información adicional y se deberían eliminar para mayor integridad de los datos.

```{r message= FALSE, warning=FALSE}
library("dplyr")
# Detección y eliminación de valores duplicados
sum(duplicated(wine_data))
wine_data <- distinct(wine_data)
```

Con estos cambios el total de registros que tenemos ahora es de:

```{r message= FALSE, warning=FALSE}
dim(wine_data)
```

## 3.2 Identificación y tratamiento de valores extremos

Consideramos valores extremos como aquellos valores que son sospechosos por alejarse demasiado del resto de datos, esto en términos numéricos quiere decir, que están demasiado alejados de la media teniendo en cuenta la desviación típica. Podemos hacer esta aproximación de una forma visual mediante un gráfico de caja o calculando los valores fuera del rango intercuartílico, podemos usar la función boxplots.stats() para esto.

```{r message= FALSE, warning=FALSE}
myColors <- c(rgb(0.1,0.1,0.7,0.5) ,rgb(0.8,0.1,0.3,0.6))

tintos <- subset(wine_data, wine_data$tipo == "tinto")
blancos <- subset(wine_data, wine_data$tipo == "blanco")
             
boxplot(wine_data$acidity ~ wine_data$tipo, main="Acidity", col =myColors )
out_ac_tinto <- boxplot(tintos$acidity, plot=FALSE)$out
out_ac_blanco <- boxplot(blancos$acidity, plot=FALSE)$out
out_ac_tinto
out_ac_blanco
```

```{r message= FALSE, warning=FALSE}
boxplot(wine_data$citric_acid ~ wine_data$tipo, main="Citric Acid", col =myColors )
out_ca_tinto <- boxplot(tintos$citric_acid, plot=FALSE)$out
out_ca_blanco <- boxplot(blancos$citric_acid, plot=FALSE)$out
out_ca_tinto
out_ca_blanco
```
```{r message= FALSE, warning=FALSE}
boxplot(wine_data$residual_sugar ~ wine_data$tipo, main="Residual Sugar", col =myColors )
out_rs_tinto <- boxplot(tintos$residual_sugar, plot=FALSE)$out
out_rs_blanco <- boxplot(blancos$residual_sugar, plot=FALSE)$out
out_rs_tinto
out_rs_blanco
```

```{r message= FALSE, warning=FALSE}
boxplot(wine_data$chlorides ~ wine_data$tipo, main="Chlorides", col =myColors )
out_ch_tinto <- boxplot(tintos$chlorides, plot=FALSE)$out
out_ch_blanco <- boxplot(blancos$chlorides, plot=FALSE)$out
out_ch_tinto
out_ch_blanco
```

```{r message= FALSE, warning=FALSE}
boxplot(wine_data$free_sulfur_dioxide ~ wine_data$tipo, main="Free Sulfur Dioxide", col =myColors )
out_fsd_tinto <- boxplot(tintos$free_sulfur_dioxide, plot=FALSE)$out
out_fsd_blanco <- boxplot(blancos$free_sulfur_dioxide, plot=FALSE)$out
out_fsd_tinto
out_fsd_blanco
```

```{r message= FALSE, warning=FALSE}
boxplot(wine_data$total_sulfur_dioxide ~ wine_data$tipo, main="Total Sulfur Dioxide", col =myColors )
out_tsd_tinto <- boxplot(tintos$total_sulfur_dioxide, plot=FALSE)$out
out_tsd_blanco <- boxplot(blancos$total_sulfur_dioxide, plot=FALSE)$out
out_tsd_tinto
out_tsd_blanco
```

```{r message=FALSE, warning=FALSE}
boxplot(wine_data$density ~ wine_data$tipo, main="Density", col =myColors )
out_de_tinto <- boxplot(tintos$density, plot=FALSE)$out
out_de_blanco <- boxplot(blancos$density, plot=FALSE)$out
out_de_tinto
out_de_blanco
```

```{r message= FALSE, warning=FALSE}
boxplot(wine_data$ph ~ wine_data$tipo, main="Ph", col =myColors )
out_ph_tinto <- boxplot(tintos$ph, plot=FALSE)$out
out_ph_blanco <- boxplot(blancos$ph, plot=FALSE)$out
out_ph_tinto
out_ph_blanco
```

```{r message= FALSE, warning=FALSE}
boxplot(wine_data$sulphates ~ wine_data$tipo, main="Sulphates", col =myColors )
out_su_tinto <- boxplot(tintos$sulphates, plot=FALSE)$out
out_su_blanco <- boxplot(blancos$sulphates, plot=FALSE)$out
out_su_tinto
out_su_blanco
```

```{r message= FALSE, warning=FALSE}
boxplot(wine_data$alcohol ~ wine_data$tipo, main="Alcohol", col =myColors )
out_al_tinto <- boxplot(tintos$alcohol, plot=FALSE)$out
out_al_blanco <- boxplot(blancos$alcohol, plot=FALSE)$out
out_al_tinto
out_al_blanco
```

Como podemos observar en los resultados anteriores, en todas las variables hay algunos valores atípicos. Aunque sí que es cierto que algunos de estos valores seguramente sean válidos y se correspondan con la realidad, dado que no tenemos el conocimiento suficiente para saberlo al cien por cien, hemos decidido eliminarlos para así asegurarnos que no causan problemas en los análisis estadísticos.

```{r message= FALSE, warning=FALSE}
# Eliminamos valores outliers de cada una de las variables

tintos <- tintos[-which(tintos$acidity %in% out_ac_tinto),]
blancos <- blancos[-which(blancos$acidity %in% out_ac_blanco),]

tintos <- tintos[-which(tintos$citric_acid %in% out_ca_tinto),]
blancos <- blancos[-which(blancos$citric_acid %in% out_ca_blanco),]

tintos <- tintos[-which(tintos$residual_sugar %in% out_rs_tinto),]
blancos <- blancos[-which(blancos$residual_sugar %in% out_rs_blanco),]

tintos <- tintos[-which(tintos$chlorides %in% out_ch_tinto),]
blancos <- blancos[-which(blancos$chlorides %in% out_ch_blanco),]

tintos <- tintos[-which(tintos$free_sulfur_dioxide %in% out_fsd_tinto),]
blancos <- blancos[-which(blancos$free_sulfur_dioxide %in% out_fsd_blanco),]

tintos <- tintos[-which(tintos$total_sulfur_dioxide %in% out_tsd_tinto),]
blancos <- blancos[-which(blancos$total_sulfur_dioxide %in% out_tsd_blanco),]

tintos <- tintos[-which(tintos$density %in% out_de_tinto),]

tintos <- tintos[-which(tintos$ph %in% out_ph_tinto),]
blancos <- blancos[-which(blancos$ph %in% out_ph_blanco),]

tintos <- tintos[-which(tintos$sulphates %in% out_su_tinto),]
blancos <- blancos[-which(blancos$sulphates %in% out_su_blanco),]

tintos <- tintos[-which(tintos$alcohol %in% out_al_tinto),]

wine_data = rbind(tintos, blancos)

ncol(wine_data)
nrow(wine_data)
```

# 4. Análisis de los datos

Nuestro análisis de datos está orientado a saber si hay diferencias en la calidad entre los vinos blancos y los vinos tintos, conocer que variables influyen mas en la calidad del vino y saber si podemos predecir y con que garantia que calidad tendrá un vino en función de sus atributos.


## 4.1 Selección de los grupos de datos que se quieren analizar/comparar (planificación de los análisis a aplicar).

Los grupos de datos que vamos a seleccionar para su análisis son la calidad con el tipo de vino, la calidad con el alcohol, el tipo de vino con el alcohol.

```{r message= FALSE, warning=FALSE}
blancos2 <- blancos[which(blancos$density %in% out_de_blanco),]
blancos3 <- blancos[-which(blancos$density %in% blancos2$density),]
#blancos <- blancos3
```

## 4.2 Comprobación de la normalidad y homogenidad de la varianza

```{r message= FALSE, warning=FALSE}
library(nortest)

qqnorm(wine_data$acidity, main = "Normal Q-Q Plot for acidity")
qqline(wine_data$acidity, col = "red")
lillie.test(tintos$acidity)

qqnorm(wine_data$citric_acid, main = "Normal Q-Q Plot for citric acid")
qqline(wine_data$citric_acid, col = "red")
lillie.test(wine_data$citric_acid)

qqnorm(wine_data$residual_sugar, main = "Normal Q-Q Plot for redidual sugar")
qqline(wine_data$residual_sugar, col = "red")
lillie.test(wine_data$residual_sugar)

qqnorm(wine_data$chlorides, main = "Normal Q-Q Plot for chlorides")
qqline(wine_data$chlorides, col = "red")
lillie.test(wine_data$chlorides)

qqnorm(wine_data$free_sulfur_dioxide, main = "Normal Q-Q Plot for free sulfur dioxide")
qqline(wine_data$free_sulfur_dioxide, col = "red")
lillie.test(wine_data$free_sulfur_dioxide)

qqnorm(wine_data$total_sulfur_dioxide, main = "Normal Q-Q Plot for total sulfur dioxide")
qqline(wine_data$total_sulfur_dioxide, col = "red")
lillie.test(wine_data$total_sulfur_dioxide)

qqnorm(wine_data$density, main = "Normal Q-Q Plot for density")
qqline(wine_data$density, col = "red")
lillie.test(wine_data$density)

qqnorm(wine_data$ph, main = "Normal Q-Q Plot for pH")
qqline(wine_data$ph, col = "red")
lillie.test(wine_data$ph)

qqnorm(wine_data$sulphates, main = "Normal Q-Q Plot for sulphates")
qqline(wine_data$sulphates, col = "red")
lillie.test(wine_data$sulphates)

qqnorm(wine_data$alcohol, main = "Normal Q-Q Plot for alcohol")
qqline(wine_data$alcohol, col = "red")
lillie.test(wine_data$alcohol)

qqnorm(wine_data$quality, main = "Normal Q-Q Plot for quality")
qqline(wine_data$quality, col = "red")
lillie.test(wine_data$quality)
```

Lo que podemos concluir de los test de normalidad de lillie es que ninguna de las variables está normalizada, ya que los p-values son muy inferiores a 0.05, y por tanto, no podemos rechazar la hipótesis nula y aceptar que existe normalidad.

No obstante sí que es cierto que todas las veriables se pueden normalizar, pues cumplen con el teorema del límite central.


Ahora vamos a estudiar la homogeneidad de varianzas

```{r message= FALSE, warning=FALSE}
library(psych)

fligner.test(wine_data$quality, wine_data$tipo)
fligner.test(wine_data$quality, wine_data$alcohol)
fligner.test(wine_data$alcohol, wine_data$tipo)
fligner.test(wine_data$quality, wine_data$ph)
```

## 4.3 Aplicación de pruebas estadísticas para comparar los grupos de datos. En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc. Aplicar al menos tres métodos de análisis diferentes.
(COMPLETAR)
Vamos a aplicar las siguientes pruebas estadísticas. 

### 4.3.1 Comparación de dos grupos. Queremos hacer un contraste de hipótesis sobre si los vinos blancos tienen la misma caildad que los vinos tintos.

### 4.3.2 Comparación de mas de dos grupos  (ANOVA). Tomando la calidad del vino como una variable categórica, comprobaremos si algún valor como la acidez del vino son iguales o distitnos

### 4.3.3 Correlación

En este punto vamos a visualizar cuál es la correlación entre todas las variables.

```{r message= FALSE, warning=FALSE}
data_corr <- cor(wine_data[,-12])
data_corr
```

```{r message= FALSE, warning=FALSE}
library(corrplot)

corrplot(data_corr)
```

### 4.3.4 Regresión lineal

```{r message= FALSE, warning=FALSE}

modelo <- lm(quality ~ acidity + citric_acid + residual_sugar + chlorides + free_sulfur_dioxide + total_sulfur_dioxide + alcohol + ph + density + sulphates, wine_data)

summary(modelo)
```


# 5. Representación de los resultados a partir de tablas y gráficas


# 6. Resolución del problema. Apartir de los resultados obtenidos, ¿cuáles son las conclusiones? ¿Los resultados permiten responder al problema?


